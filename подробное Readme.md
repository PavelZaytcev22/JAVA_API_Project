

---

# Умный дом с виртуальными устройствами — подробный функционал и поведение

проект симулирует работу системы «умного дома», где Raspberry Pi (в нашем случае VM) выступает в роли «центрального хаба», а подключённые устройства (лампы, датчики, сирены) эмулируются программно. Android-клиент выполняет роль пользовательского интерфейса для управления, мониторинга и настройки сценариев автоматизации.

---

## 1. Цель проекта

Создать систему виртуального «умного дома», включающую:
- эмуляцию различных устройств (освещение, датчики движения/температуры, сирена);    
- хранение состояния устройств на Raspberry Pi (VM);    
- взаимодействие через REST API / WebSocket;    
- мобильное приложение для управления и мониторинга;    
- демонстрацию базовой автоматизации и сценариев.    

---

## 2. Компоненты системы

- **Raspberry Pi (VM)** — контроллер и хаб.    
    - Эмуляция устройств.        
    - Локальное хранение состояния в SQLite.        
    - REST API / WebSocket для управления и событий.        
    - Логирование действий и событий (архив).        
    - Планировщик для сценариев.        
- **Android-клиент** — интерфейс пользователя.    
    - Управление устройствами (вкл/выкл, яркость и т.п.).        
    - Просмотр текущего состояния и журналов.        
    - Настройка сценариев (например, «ночной режим»).        
    - Получение уведомлений при тревоге (например, движение).        

---

## 3. Функционал по сторонам

### На стороне Raspberry Pi (VM)
- **Эмуляция устройств**:    
    - Умная лампа: состояния «вкл/выкл», яркость 0–100%.        
    - Датчик движения: случайная генерация событий.        
    - Датчик температуры/влажности: синтетические значения.        
    - Сирена: состояние «выкл/вкл».        
- **API**:    
    - `GET /devices` — список устройств и их текущее состояние.        
    - `POST /device/{id}/action` — выполнить действие (включить лампу, поднять сирену).        
    - `GET /logs` — журнал событий.        
    - `POST /scenario` — создание сценария (например: «если движение ночью → лампа+сирена»).        
- **Автоматизация**:    
    - Реакция на события датчиков.        
    - Встроенные сценарии (например, тревога ночью).        
- **Хранение**:    
    - SQLite с таблицами `devices`, `events`, `scenarios`.        
    - Логирование всех изменений состояния.        

### На стороне Android
- **Управление**:    
    - Вкл/выкл лампу.        
    - Изменение яркости.        
    - Вкл/выкл сирену.        
- **Мониторинг**:    
    - Просмотр текущего состояния всех устройств.        
    - История событий (когда сработал датчик, когда включалась лампа).        
- **Уведомления**:    
    - Push/локальные уведомления при срабатывании тревоги (например, движение).        
- **Сценарии**:    
    - Интерфейс для создания правил (например: «если температура < 18 → включить отопление»).        
- **Визуализация**:    
    - Дашборд с иконками устройств.        
    - Лог событий в виде списка/таймлайна.        

---

## 4. Модель данных (SQLite на Pi)

```sql
CREATE TABLE devices (
  id INTEGER PRIMARY KEY,
  name TEXT,
  type TEXT,            -- lamp, motion_sensor, temp_sensor, siren
  state TEXT,           -- json-объект со свойствами (например {"on":true,"brightness":80})
  last_update INTEGER   -- unix timestamp
);

CREATE TABLE events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  device_id INTEGER,
  ts INTEGER NOT NULL,
  event_type TEXT,       -- "motion_detected", "state_change", ...
  payload TEXT
);

CREATE TABLE scenarios (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT,
  condition TEXT,        -- JSON-условие
  action TEXT            -- JSON-действие
);
```
---

## 5. Протокол обмена

### REST (JSON)

**Пример списка устройств**:

```json
[
  {"id":1,"name":"Лампа гостиная","type":"lamp","state":{"on":true,"brightness":70}},
  {"id":2,"name":"Датчик движения","type":"motion_sensor","state":{"motion":false}},
  {"id":3,"name":"Сирена","type":"siren","state":{"on":false}}
]
```

**Пример действия (включить лампу)**:

```http
POST /device/1/action
{
  "action":"set",
  "params":{"on":true,"brightness":100}
}
```

**Пример события**:

```json
{"device_id":2,"ts":169XXX,"event_type":"motion_detected","payload":"{}"}
```

---

## 6. Симуляция устройств
- Датчик движения: случайное событие каждые `N` минут.    
- Датчик температуры: плавные колебания с шумом.    
- Лампа и сирена: управляются только командами пользователя/сценариев.    

---

## 7. Автоматизация

Примеры встроенных сценариев:
1. **Охрана**: если сработал датчик движения ночью → включить сирену и лампу.    
2. **Комфорт**: если температура < 18°C → уведомление на Android.    
3. **Энергосбережение**: если нет движения 15 минут → выключить все лампы.    

---

## 8. UI / Визуализация (Android)
- **Главный экран (Дашборд)**    
    - Иконки устройств (лампа, датчик, сирена).        
    - Индикация состояния.        
    - Кнопки управления.        
- **История событий**    
    - Лента событий (когда включили лампу, движение, сработала сирена).        
    - Возможность фильтрации (по устройству/типу).        
- **Сценарии**    
    - Список сценариев.        
    - Создание правил: «если [условие] → тогда [действие]».        
- **Уведомления**    
    - Локальные уведомления при тревоге.        
    - Иконка в статус-баре Android.        

---
## 9. Тестовые сценарии

1. Включить лампу вручную с Android.    
2. Сгенерировать событие движения → сирена включается автоматически.    
3. Проверить лог событий на Android.    
4. Настроить сценарий: «Если температура < 18 → уведомление».    
5. Запустить генератор температуры → получить уведомление.    

---
## 10. План разработки

1. **Прототип Pi-хаба**: эмуляция устройств, SQLite, REST `/devices`.    
2. **Android**: список устройств, базовое управление (лампа/сирена).    
3. **События**: эмуляция датчиков, логирование, просмотр на Android.    
4. **Автоматизация**: встроенные сценарии на Pi.    
5. **Уведомления Android**.    
6. **Редактор сценариев на Android** (опционально).    

---
